<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ramadan Strivers">
    <meta name="theme-color" content="#0a0f1a">
    <meta name="description" content="Track your Ramadan journey - From Muslim to Mu'min">
    <title>Ramadan Strivers</title>
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Ramadan%20Strivers%22%2C%22short_name%22%3A%22Ramadan%22%2C%22description%22%3A%22Track%20your%20Ramadan%20journey%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0f1a%22%2C%22theme_color%22%3A%22%230a0f1a%22%2C%22orientation%22%3A%22portrait%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%2520viewBox%3D%270%25200%2520100%2520100%27%253E%253Crect%2520fill%3D%27%25230a0f1a%27%2520width%3D%27100%27%2520height%3D%27100%27%2520rx%3D%2720%27%2F%253E%253Ctext%2520x%3D%2750%27%2520y%3D%2768%27%2520font-size%3D%2755%27%2520text-anchor%3D%27middle%27%253E%25F0%259F%258C%2599%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0f1a' width='100' height='100' rx='20'/><text x='50' y='68' font-size='55' text-anchor='middle'>üåô</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
:root{
    --bg-primary:#f7f5f0;--bg-secondary:#fff;--bg-header:#0a1628;
    --text-primary:#1a1a2e;--text-secondary:#555566;--text-muted:#888899;
    --accent-green:#1b5e3b;--accent-green-light:#2a7b52;--accent-green-glow:rgba(27,94,59,0.15);
    --accent-gold:#c9a84c;--accent-gold-light:#f5ecd3;--accent-gold-glow:rgba(201,168,76,0.2);
    --border-color:#e2ddd4;--success:#2e7d32;--warning:#e6a817;--error:#c0392b;
    --shadow-sm:0 1px 3px rgba(0,0,0,0.06);--shadow-md:0 4px 12px rgba(0,0,0,0.08);
    --shadow-lg:0 8px 30px rgba(0,0,0,0.12);--card-bg:#fff;--overlay:rgba(0,0,0,0.5);
    --radius:16px;--radius-sm:10px;
    --safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom);
    --font-display:'Amiri',serif;--font-body:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif;
    --geo-opacity:0.04;
}
[data-theme="dark"]{
    --bg-primary:#0a0f1a;--bg-secondary:#111827;--bg-header:#050a14;
    --text-primary:#e8e4dd;--text-secondary:#9ca3af;--text-muted:#6b7280;
    --accent-green:#34d399;--accent-green-light:#6ee7b7;--accent-green-glow:rgba(52,211,153,0.1);
    --accent-gold:#f5c542;--accent-gold-light:#2a2311;--accent-gold-glow:rgba(245,197,66,0.12);
    --border-color:#1f2937;--success:#22c55e;--warning:#eab308;--error:#ef4444;
    --shadow-sm:0 1px 3px rgba(0,0,0,0.2);--shadow-md:0 4px 12px rgba(0,0,0,0.3);
    --shadow-lg:0 8px 30px rgba(0,0,0,0.4);--card-bg:#1a1f2e;--overlay:rgba(0,0,0,0.75);
    --geo-opacity:0.06;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{font-family:var(--font-body);background:var(--bg-primary);color:var(--text-primary);min-height:100dvh;overflow-x:hidden;padding-bottom:calc(76px + var(--safe-bottom));line-height:1.6;-webkit-font-smoothing:antialiased;position:relative}

/* ===== GEOMETRIC PATTERN BG ===== */
body::before{
    content:'';position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;
    opacity:var(--geo-opacity);
    background-image:
        url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 30L30 60L0 30Z' fill='none' stroke='%23c9a84c' stroke-width='0.5'/%3E%3Cpath d='M30 10L50 30L30 50L10 30Z' fill='none' stroke='%23c9a84c' stroke-width='0.3'/%3E%3Cpath d='M30 20L40 30L30 40L20 30Z' fill='none' stroke='%23c9a84c' stroke-width='0.3'/%3E%3C/svg%3E");
    background-size:60px 60px;
    animation:geoShift 60s linear infinite;
}
@keyframes geoShift{from{background-position:0 0}to{background-position:60px 60px}}
body>*{position:relative;z-index:1}

/* ===== HEADER ===== */
.header{background:linear-gradient(180deg,var(--bg-header) 0%,rgba(10,22,40,0.97) 100%);color:#fff;padding:calc(14px + var(--safe-top)) 20px 14px;position:sticky;top:0;z-index:100;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid rgba(201,168,76,0.3)}
.header-content{display:flex;justify-content:space-between;align-items:center;max-width:560px;margin:0 auto}
.header h1{font-family:var(--font-display);font-size:1.4em;font-weight:700;letter-spacing:.5px}
.header-tagline{font-size:.72em;opacity:.7;display:block;color:var(--accent-gold);font-family:var(--font-display);font-style:italic;margin-top:2px}
.theme-toggle{background:rgba(255,255,255,.08);border:1.5px solid rgba(201,168,76,.4);color:var(--accent-gold);width:42px;height:42px;font-size:1.2em;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:12px;transition:all .2s}
.theme-toggle:active{transform:scale(.92)}

/* ===== DAY BANNER ===== */
.day-banner{background:linear-gradient(135deg,#0f2027 0%,#203a43 50%,#1b5e3b 100%);color:#fff;padding:22px 20px;text-align:center;position:relative;overflow:hidden}
.day-banner::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at center,rgba(201,168,76,.08) 0%,transparent 60%);animation:shimmer 8s ease-in-out infinite}
@keyframes shimmer{0%,100%{transform:translateX(-20%)}50%{transform:translateX(20%)}}
.day-banner.last-ten{background:linear-gradient(135deg,#0a0a2e 0%,#1a1040 40%,#2d1b69 100%);border-bottom:2px solid var(--accent-gold)}
.day-banner .day-number{font-family:var(--font-display);font-size:2.2em;font-weight:700;position:relative}
.day-banner .day-label{font-size:.85em;opacity:.8;margin-top:2px}
.day-banner .hadith{font-family:var(--font-display);font-style:italic;font-size:.88em;margin-top:12px;opacity:.85;line-height:1.6;max-width:500px;margin-left:auto;margin-right:auto;position:relative}
.odd-night-badge{display:inline-block;background:linear-gradient(135deg,#f5c542,#d4a520);color:#1a1a2e;padding:5px 16px;font-size:.75em;font-weight:700;margin-top:10px;text-transform:uppercase;letter-spacing:1.5px;border-radius:20px;box-shadow:0 0 20px rgba(245,197,66,.3);animation:glow 2s ease-in-out infinite alternate}
@keyframes glow{from{box-shadow:0 0 10px rgba(245,197,66,.3)}to{box-shadow:0 0 25px rgba(245,197,66,.5)}}
.last-ten-message{margin-top:8px;font-size:.82em;opacity:.9;color:#ffd700;font-family:var(--font-display)}

/* ===== DAY SELECTOR ===== */
.day-selector{display:flex;align-items:center;justify-content:center;gap:16px;padding:12px 20px;background:var(--bg-secondary);border-bottom:1px solid var(--border-color)}
.day-selector button{width:40px;height:40px;border-radius:50%;border:2px solid var(--border-color);background:var(--card-bg);color:var(--text-primary);font-size:1.1em;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.day-selector button:active{transform:scale(.9);background:var(--accent-green-glow)}
.day-selector .day-display{font-weight:600;font-size:.95em;color:var(--text-secondary);min-width:80px;text-align:center}

/* ===== MAIN CONTENT ===== */
.main-content{max-width:560px;margin:0 auto;padding:16px}
.tab-content{display:none;animation:fadeIn .25s ease}
.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* ===== PROGRESS CARD ===== */
.progress-card{background:linear-gradient(135deg,var(--accent-green),#1a6b42);color:#fff;padding:20px;margin-bottom:14px;border-radius:var(--radius);box-shadow:var(--shadow-lg);overflow:hidden;position:relative}
[data-theme="dark"] .progress-card{background:linear-gradient(135deg,#0f2922,#163b2d);border:1px solid rgba(52,211,153,.2)}
.progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.progress-title{font-weight:600;font-size:.9em;opacity:.9}
.progress-percentage{font-size:2em;font-weight:700;font-family:var(--font-display)}
.progress-bar-container{background:rgba(255,255,255,.2);height:8px;border-radius:4px;margin-bottom:10px;overflow:hidden}
.progress-bar{height:100%;background:linear-gradient(90deg,#f5c542,#ffd700);border-radius:4px;transition:width .4s}
.progress-stats{display:flex;justify-content:space-between;font-size:.82em;opacity:.85}
.points-display{color:#ffd700;font-weight:600}

/* ===== STREAKS ===== */
.streaks-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.streak-card{background:var(--card-bg);border:1.5px solid var(--border-color);padding:14px 8px;text-align:center;border-radius:var(--radius-sm);transition:all .2s;box-shadow:var(--shadow-sm)}
.streak-card.active{border-color:var(--accent-gold);box-shadow:0 0 12px var(--accent-gold-glow)}
.streak-icon{font-size:1.4em;margin-bottom:4px}
.streak-count{font-size:1.4em;font-weight:700;color:var(--accent-green);font-family:var(--font-display)}
.streak-label{font-size:.68em;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600}

/* ===== QURAN TRACKER ===== */
.quran-tracker{background:linear-gradient(135deg,#1a1040,#2d1b69 60%,#1b3a5e);color:#fff;padding:20px;margin-bottom:14px;border-radius:var(--radius);border:1px solid rgba(201,168,76,.25);overflow:hidden;position:relative}
[data-theme="light"] .quran-tracker{background:linear-gradient(135deg,#1a2a44,#2a3d5e 60%,#1b5e3b)}
.quran-tracker h3{font-family:var(--font-display);margin-bottom:6px;font-size:1.1em}
.quran-subtitle{font-size:.78em;opacity:.75;margin-bottom:14px;font-style:italic;font-family:var(--font-display);line-height:1.5}
.quran-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:14px}
.quran-stat{background:rgba(255,255,255,.1);padding:12px 8px;border-radius:var(--radius-sm);text-align:center}
.quran-stat-value{font-size:1.4em;font-weight:700;font-family:var(--font-display);color:#ffd700}
.quran-stat-label{font-size:.68em;opacity:.8;margin-top:2px}
.quran-juz{background:rgba(255,255,255,.08);padding:10px 14px;border-radius:var(--radius-sm);margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;font-size:.88em}
.quran-juz-label{opacity:.8}
.quran-juz-value{font-weight:700;color:#ffd700;font-family:var(--font-display);font-size:1.1em}
.quran-input-row{display:flex;gap:10px;align-items:center}
.quran-input-row input{flex:1;padding:10px 14px;border-radius:var(--radius-sm);border:1.5px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:#fff;font-size:1em;font-family:var(--font-body)}
.quran-input-row input::placeholder{color:rgba(255,255,255,.4)}
.quran-input-row button{padding:10px 18px;border-radius:var(--radius-sm);border:none;background:var(--accent-gold);color:#1a1a2e;font-weight:700;cursor:pointer;font-family:var(--font-body);font-size:.9em;white-space:nowrap}
.quran-input-row button:active{transform:scale(.96)}
.quran-progress-bar{background:rgba(255,255,255,.15);height:8px;border-radius:4px;margin-top:14px;overflow:hidden}
.quran-progress-fill{height:100%;background:linear-gradient(90deg,#34d399,#ffd700);border-radius:4px;transition:width .4s}
.quran-message{font-size:.82em;opacity:.8;margin-top:10px;font-style:italic;font-family:var(--font-display);line-height:1.5;text-align:center}
.quran-app-link{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.1);padding:10px 14px;border-radius:var(--radius-sm);margin-top:12px;text-decoration:none;color:#fff;transition:all .2s}
.quran-app-link:active{background:rgba(255,255,255,.18)}
.quran-app-link-text{font-size:.78em;opacity:.85;flex:1}
.quran-app-link-text strong{display:block;font-size:1.1em;margin-bottom:2px}
.quran-app-link-badge{padding:3px 10px;background:rgba(255,255,255,.15);border-radius:12px;font-size:.7em;font-weight:600}

/* ===== SECTIONS ===== */
.section{background:var(--card-bg);border:1.5px solid var(--border-color);margin-bottom:12px;overflow:hidden;border-radius:var(--radius);box-shadow:var(--shadow-sm)}
.section.last-ten-section{border-color:var(--accent-gold);box-shadow:0 0 20px var(--accent-gold-glow)}
.section-header{background:var(--accent-green);color:#fff;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;border-radius:var(--radius) var(--radius) 0 0}
[data-theme="dark"] .section-header{background:linear-gradient(135deg,#0f2922,#163b2d)}
.section-header h2{font-size:.88em;font-weight:600;letter-spacing:.3px}
.section-progress{display:flex;align-items:center;gap:8px}
.section-progress-text{font-size:.78em;opacity:.85}
.toggle-icon{font-size:.7em;transition:transform .3s;color:var(--accent-gold)}
.section.collapsed .toggle-icon{transform:rotate(-90deg)}
.section-content{padding:12px;max-height:8000px;overflow:hidden;transition:max-height .35s,padding .35s}
.section.collapsed .section-content{max-height:0;padding:0 12px}
.subsection-title{font-size:.82em;font-weight:700;color:var(--accent-gold);padding:10px 0 8px;margin:12px 0 8px;text-transform:uppercase;letter-spacing:1px;border-bottom:1.5px solid var(--accent-gold-glow)}
.hadith-note{background:var(--accent-gold-glow);border-left:3px solid var(--accent-gold);padding:12px 14px;margin:8px 0 12px;border-radius:0 var(--radius-sm) var(--radius-sm) 0;font-family:var(--font-display);font-style:italic;font-size:.88em;line-height:1.6;color:var(--text-secondary)}
.app-inline-link{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--accent-green-glow);border:1.5px solid var(--border-color);border-radius:var(--radius-sm);margin:8px 0 12px;text-decoration:none;color:var(--text-primary);transition:all .2s}
.app-inline-link:active{transform:scale(.98);border-color:var(--accent-gold)}
.app-inline-link .ail-icon{font-size:1.6em;flex-shrink:0}
.app-inline-link .ail-text{font-size:.82em;line-height:1.4;flex:1}
.app-inline-link .ail-text strong{color:var(--accent-green)}
.app-inline-link .ail-arrow{color:var(--accent-green);font-size:1.2em}
.checklist-item{display:flex;align-items:flex-start;gap:12px;padding:12px 14px;background:var(--bg-primary);border:1px solid var(--border-color);margin-bottom:6px;transition:all .2s;border-radius:var(--radius-sm);cursor:pointer}
.checklist-item:active{transform:scale(.985)}
.checklist-item.checked{opacity:.55;background:var(--accent-green-glow)}
.checklist-item input[type="checkbox"]{width:22px;height:22px;cursor:pointer;accent-color:var(--accent-green);flex-shrink:0;margin-top:1px;border-radius:4px}
.checklist-item label{flex:1;cursor:pointer;font-size:.92em;line-height:1.5}
.checklist-item.checked label{text-decoration:line-through}
.item-points{font-size:.72em;color:var(--accent-gold);font-weight:700;margin-left:6px}
.reference{display:block;font-size:.78em;color:var(--text-muted);font-style:italic;margin-top:2px}
.reference a{color:var(--accent-green);text-decoration:none}
.explanation{display:block;font-size:.78em;color:var(--text-secondary);margin-top:3px;line-height:1.4}

/* ===== HEATMAP ===== */
.heatmap-container{background:var(--card-bg);border:1.5px solid var(--border-color);padding:18px;border-radius:var(--radius);margin-bottom:14px}
.heatmap-container h3{color:var(--accent-green);font-family:var(--font-display);font-size:1em;margin-bottom:14px}
.heatmap-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:4px}
.heatmap-cell{aspect-ratio:1;border-radius:3px;position:relative;cursor:pointer;transition:transform .15s}
.heatmap-cell:hover{transform:scale(1.15)}
.heatmap-cell.l0{background:var(--border-color)}
.heatmap-cell.l1{background:#2d5016}
.heatmap-cell.l2{background:#3b7a1a}
.heatmap-cell.l3{background:#4caf20}
.heatmap-cell.l4{background:#66d42a}
[data-theme="light"] .heatmap-cell.l1{background:#c6e48b}
[data-theme="light"] .heatmap-cell.l2{background:#7bc96f}
[data-theme="light"] .heatmap-cell.l3{background:#239a3b}
[data-theme="light"] .heatmap-cell.l4{background:#196127}
.heatmap-cell.today-cell{box-shadow:0 0 0 2px var(--accent-gold)}
.heatmap-legend{display:flex;align-items:center;gap:6px;margin-top:10px;font-size:.72em;color:var(--text-muted);justify-content:flex-end}
.heatmap-legend span{width:12px;height:12px;border-radius:2px;display:inline-block}

/* ===== CALENDAR ===== */
.calendar-container{background:var(--card-bg);border:1.5px solid var(--border-color);padding:18px;border-radius:var(--radius)}
.calendar-header{text-align:center;margin-bottom:16px}
.calendar-header h2{color:var(--accent-green);font-family:var(--font-display);font-size:1.2em}
.calendar-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
.calendar-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border:1.5px solid var(--border-color);background:var(--bg-primary);cursor:pointer;transition:all .2s;position:relative;border-radius:var(--radius-sm)}
.calendar-day:active{transform:scale(.93)}
.calendar-day.today{border-color:var(--accent-gold);box-shadow:0 0 12px var(--accent-gold-glow)}
.calendar-day.completed-high{background:var(--success);color:#fff;border-color:var(--success)}
.calendar-day.completed-med{background:var(--warning);color:#fff;border-color:var(--warning)}
.calendar-day.completed-low{background:var(--error);color:#fff;border-color:var(--error)}
.calendar-day.odd-night::after{content:'üåô';position:absolute;top:2px;right:3px;font-size:.55em}
.calendar-day-number{font-size:1.05em;font-weight:700}
.calendar-day-percent{font-size:.6em;opacity:.85}

/* ===== STATS / CHARTS ===== */
.stats-section{background:var(--card-bg);border:1.5px solid var(--border-color);padding:20px;margin-bottom:14px;border-radius:var(--radius);box-shadow:var(--shadow-sm)}
.stats-section h3{color:var(--accent-green);font-size:1em;margin-bottom:14px;padding-bottom:8px;border-bottom:1.5px solid var(--accent-gold-glow);font-family:var(--font-display)}
.stat-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border-color)}
.stat-row:last-child{border-bottom:none}
.stat-label{color:var(--text-secondary);font-size:.92em}
.stat-value{font-weight:600;color:var(--accent-green)}
.chart-container{position:relative;height:220px;margin:14px 0}
.category-bar{margin-bottom:14px}
.category-bar-header{display:flex;justify-content:space-between;margin-bottom:5px;font-size:.88em}
.category-bar-track{background:var(--border-color);height:8px;border-radius:4px;overflow:hidden}
.category-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent-green),var(--accent-gold));border-radius:4px;transition:width .4s}
.badges-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.badge-item{text-align:center;padding:14px 6px;background:var(--bg-primary);border:1.5px solid var(--border-color);border-radius:var(--radius-sm);transition:all .2s}
.badge-item.unlocked{border-color:var(--accent-gold);background:var(--accent-gold-glow)}
.badge-item.locked{opacity:.35;filter:grayscale(1)}
.badge-icon{font-size:1.8em;margin-bottom:4px}
.badge-name{font-size:.68em;font-weight:600;color:var(--text-secondary)}
.comparison-card{background:var(--accent-green-glow);border:1.5px solid var(--border-color);border-radius:var(--radius);padding:16px;margin-bottom:14px;text-align:center}
.comparison-card .comp-value{font-size:1.8em;font-weight:700;color:var(--accent-green);font-family:var(--font-display)}
.comparison-card .comp-label{font-size:.82em;color:var(--text-secondary);margin-top:4px}
.comparison-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}

/* ===== WEEKLY SUMMARY ===== */
.weekly-summary{background:linear-gradient(135deg,var(--accent-green),#1a6b42);color:#fff;padding:20px;margin-bottom:14px;border-radius:var(--radius)}
[data-theme="dark"] .weekly-summary{background:linear-gradient(135deg,#0f2922,#163b2d);border:1px solid rgba(52,211,153,.2)}
.weekly-summary h3{margin-bottom:14px;font-family:var(--font-display)}
.weekly-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.weekly-stat{background:rgba(255,255,255,.12);padding:12px;text-align:center;border-radius:var(--radius-sm)}
.weekly-stat-value{font-size:1.4em;font-weight:700;font-family:var(--font-display)}
.weekly-stat-label{font-size:.72em;opacity:.85}

/* ===== SETTINGS ===== */
.setting-item{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border-color)}
.setting-label{font-weight:500;font-size:.95em}
.setting-desc{font-size:.82em;color:var(--text-muted)}
.toggle-switch{width:50px;height:28px;background:var(--border-color);border:none;cursor:pointer;position:relative;border-radius:14px}
.toggle-switch::after{content:'';position:absolute;width:22px;height:22px;background:#fff;top:3px;left:3px;transition:transform .2s;border-radius:50%}
.toggle-switch.active{background:var(--accent-green)}
.toggle-switch.active::after{transform:translateX(22px)}
.btn{padding:13px 24px;border:1.5px solid var(--accent-green);background:var(--accent-green);color:#fff;font-weight:600;cursor:pointer;transition:all .2s;width:100%;margin-top:10px;border-radius:var(--radius-sm);font-family:var(--font-body);font-size:.92em}
.btn:active{transform:scale(.98)}
.btn-outline{background:transparent;color:var(--accent-green)}
.btn-danger{border-color:var(--error);background:var(--error)}
.btn-gold{border-color:var(--accent-gold);background:linear-gradient(135deg,#f5c542,#d4a520);color:#1a1a2e}

/* ===== FOOTER ===== */
.app-footer{text-align:center;padding:30px 20px 20px;margin-top:20px;border-top:1px solid var(--border-color);color:var(--text-muted);font-size:.82em;line-height:1.7}
.app-footer .dua{font-family:var(--font-display);font-style:italic;font-size:1.05em;color:var(--accent-gold);margin-bottom:12px}
.app-footer a{color:var(--accent-green);text-decoration:none;font-weight:600}

/* ===== BOTTOM NAV ===== */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--card-bg);border-top:1px solid var(--border-color);display:flex;padding-bottom:var(--safe-bottom);z-index:100;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.nav-item{flex:1;padding:10px 0;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;color:var(--text-muted);border:none;background:transparent;transition:color .2s;font-family:var(--font-body)}
.nav-item.active{color:var(--accent-green)}
.nav-item .nav-icon{font-size:1.35em}
.nav-item .nav-label{font-size:.65em;font-weight:700;text-transform:uppercase;letter-spacing:.5px}

/* ===== MODAL ===== */
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:var(--overlay);z-index:200;align-items:center;justify-content:center;padding:20px}
.modal-overlay.active{display:flex}
.modal{background:var(--card-bg);border:1.5px solid var(--border-color);width:100%;max-width:420px;max-height:80vh;overflow-y:auto;border-radius:var(--radius)}
.modal-header{background:var(--accent-green);color:#fff;padding:16px 20px;display:flex;justify-content:space-between;align-items:center;border-radius:var(--radius) var(--radius) 0 0}
[data-theme="dark"] .modal-header{background:linear-gradient(135deg,#0f2922,#163b2d)}
.modal-header h3{font-size:1em;font-family:var(--font-display)}
.modal-close{background:transparent;border:none;color:#fff;font-size:1.5em;cursor:pointer}
.modal-body{padding:20px}

/* ===== INSTALL BANNER ===== */
.install-banner{display:none;background:linear-gradient(135deg,var(--accent-green),#1a6b42);color:#fff;padding:16px 20px;margin-bottom:14px;border-radius:var(--radius);box-shadow:var(--shadow-md)}
.install-banner.show{display:flex;align-items:center;gap:14px}
.install-banner .ib-text{flex:1;font-size:.88em;line-height:1.4}
.install-banner .ib-text strong{display:block;font-size:1.05em;margin-bottom:2px}
.install-banner button{padding:8px 18px;border-radius:var(--radius-sm);border:none;background:#fff;color:var(--accent-green);font-weight:700;cursor:pointer;font-size:.85em;white-space:nowrap}
.install-banner .ib-close{background:transparent;color:rgba(255,255,255,.7);font-size:1.4em;padding:0 4px}

/* ===== TOAST ===== */
.toast-container{position:fixed;top:calc(80px + var(--safe-top));left:50%;transform:translateX(-50%);z-index:300;display:flex;flex-direction:column;gap:10px;pointer-events:none;max-width:90%}
.toast{background:var(--accent-green);color:#fff;padding:12px 20px;font-size:.88em;font-weight:500;border-radius:var(--radius-sm);animation:slideDown .3s ease,fadeOut .3s ease 2.7s;box-shadow:var(--shadow-lg)}
.toast.badge-toast{background:linear-gradient(135deg,#f5c542,#d4a520);color:#1a1a2e}
@keyframes slideDown{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes fadeOut{from{opacity:1}to{opacity:0}}

@media(max-width:400px){.header h1{font-size:1.15em}.streaks-row{grid-template-columns:repeat(2,1fr)}.badges-grid{grid-template-columns:repeat(3,1fr)}.calendar-grid{grid-template-columns:repeat(5,1fr)}.heatmap-grid{gap:3px}}
@supports(padding-top:env(safe-area-inset-top)){.header{padding-top:calc(14px + env(safe-area-inset-top))}}
    </style>
</head>
<body>
<header class="header"><div class="header-content"><div><h1>üåô RAMADAN STRIVERS</h1><span class="header-tagline">From Muslim to Mu'min ‚Äî bringing out our best</span></div><div><button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme"><span id="themeIcon">‚òÄÔ∏è</span></button></div></div></header>

<div class="day-banner" id="dayBanner">
    <div class="day-number">Day <span id="currentDay">1</span></div>
    <div class="day-label">of Ramadan 1447</div>
    <div class="hadith" id="dailyHadith"></div>
    <div id="oddNightBadge"></div>
    <div id="lastTenMsg"></div>
</div>

<div class="day-selector">
    <button onclick="changeDay(-1)" aria-label="Previous day">‚óÄ</button>
    <div class="day-display" id="dayDisplay">Day 1 / 30</div>
    <button onclick="changeDay(1)" aria-label="Next day">‚ñ∂</button>
</div>

<main class="main-content">
<!-- INSTALL BANNER -->
<div class="install-banner" id="installBanner">
    <div style="font-size:1.8em">üåô</div>
    <div class="ib-text"><strong>Install Ramadan Strivers</strong>Add to your home screen for the best experience ‚Äî works offline!</div>
    <button id="installBtn" onclick="installApp()">Install</button>
    <button class="ib-close" onclick="dismissInstall()">&times;</button>
</div>

<!-- TODAY TAB -->
<div class="tab-content active" id="tab-today">
    <div class="progress-card">
        <div class="progress-header"><span class="progress-title">Today's Progress</span><span class="progress-percentage" id="progressPercent">0%</span></div>
        <div class="progress-bar-container"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
        <div class="progress-stats"><span id="progressCount">0 of 0 completed</span><span class="points-display">üî• <span id="todayPoints">0</span> pts</span></div>
    </div>
    <div class="streaks-row">
        <div class="streak-card" id="streakFajr"><div class="streak-icon">‚òÄÔ∏è</div><div class="streak-count" id="streakFajrCount">0</div><div class="streak-label">Fajr</div></div>
        <div class="streak-card" id="streakNight"><div class="streak-icon">üåô</div><div class="streak-count" id="streakNightCount">0</div><div class="streak-label">Night</div></div>
        <div class="streak-card" id="streakQuran"><div class="streak-icon">üìñ</div><div class="streak-count" id="streakQuranCount">0</div><div class="streak-label">Quran</div></div>
        <div class="streak-card" id="streakCharity"><div class="streak-icon">üíù</div><div class="streak-count" id="streakCharityCount">0</div><div class="streak-label">Sadaqah</div></div>
    </div>
    <!-- Quran Tracker -->
    <div class="quran-tracker">
        <h3>üìñ Quran Completion Tracker</h3>
        <div class="quran-subtitle">"The month of Ramadan in which the Quran was revealed as guidance for mankind." ‚Äî Quran 2:185<br>Read it. Understand it. Live by it.</div>
        <div class="quran-stats">
            <div class="quran-stat"><div class="quran-stat-value" id="quranPagesRead">0</div><div class="quran-stat-label">Pages Read</div></div>
            <div class="quran-stat"><div class="quran-stat-value" id="quranPagesLeft">604</div><div class="quran-stat-label">Pages Left</div></div>
            <div class="quran-stat"><div class="quran-stat-value" id="quranDaysLeft">30</div><div class="quran-stat-label">Days Left</div></div>
            <div class="quran-stat"><div class="quran-stat-value" id="quranPagesPerDay">~20</div><div class="quran-stat-label">Pages/Day Needed</div></div>
        </div>
        <div class="quran-juz"><span class="quran-juz-label">Current Juz</span><span class="quran-juz-value" id="quranJuz">‚Äî / 30</span></div>
        <div class="quran-input-row">
            <input type="number" id="quranPagesInput" placeholder="Pages read today" min="0" step="1">
            <button onclick="logQuranPages()">Log</button>
        </div>
        <div class="quran-progress-bar"><div class="quran-progress-fill" id="quranProgressFill" style="width:0%"></div></div>
        <div class="quran-message" id="quranMessage">Read, understand, and implement ‚Äî even one ayah a day transforms your life.</div>
        <a href="https://tarteel.ai/" target="_blank" rel="noopener" class="quran-app-link">
            <div style="font-size:1.4em">üìñ</div>
            <div class="quran-app-link-text"><strong>Tarteel AI</strong>AI Quran recitation helper ‚Äî tajweed correction & memorisation</div>
            <div class="quran-app-link-badge">Open ‚Üí</div>
        </a>
    </div>
    <div id="checklistContainer"></div>
</div>

<!-- CALENDAR TAB -->
<div class="tab-content" id="tab-calendar">
    <div class="heatmap-container">
        <h3>üü© Consistency Heatmap</h3>
        <div class="heatmap-grid" id="heatmapGrid"></div>
        <div class="heatmap-legend">Less <span class="l0"></span><span class="l1"></span><span class="l2"></span><span class="l3"></span><span class="l4"></span> More</div>
    </div>
    <div class="calendar-container">
        <div class="calendar-header"><h2>üìÖ 30-Day Journey</h2><p style="color:var(--text-muted);font-size:.82em;margin-top:5px">Tap any day to view details</p></div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>
    <div class="stats-section" style="margin-top:14px"><h3>üìä Legend</h3>
        <div style="display:flex;gap:14px;flex-wrap:wrap;font-size:.82em">
            <span><span style="display:inline-block;width:14px;height:14px;background:var(--success);vertical-align:middle;margin-right:5px;border-radius:3px"></span>76-100%</span>
            <span><span style="display:inline-block;width:14px;height:14px;background:var(--warning);vertical-align:middle;margin-right:5px;border-radius:3px"></span>51-75%</span>
            <span><span style="display:inline-block;width:14px;height:14px;background:var(--error);vertical-align:middle;margin-right:5px;border-radius:3px"></span>1-50%</span>
            <span>üåô Odd Night</span>
        </div>
    </div>
</div>

<!-- STATS TAB -->
<div class="tab-content" id="tab-stats">
    <div class="weekly-summary" id="weeklySummary" style="display:none"><h3>üìä Weekly Summary</h3><div class="weekly-stats" id="weeklyStats"></div></div>
    <!-- Comparative Analytics -->
    <div class="comparison-row" id="comparisonRow">
        <div class="comparison-card"><div class="comp-value" id="compWeek1">0%</div><div class="comp-label">Week 1 Avg</div></div>
        <div class="comparison-card"><div class="comp-value" id="compWeek2">0%</div><div class="comp-label">Week 2 Avg</div></div>
    </div>
    <div class="comparison-card" id="compDelta" style="display:none;margin-bottom:14px"><div class="comp-value" id="compDeltaVal">‚Äî</div><div class="comp-label" id="compDeltaLabel">Compared to last week</div></div>
    <!-- Charts -->
    <div class="stats-section"><h3>üìà Daily Progress Trend</h3><div class="chart-container"><canvas id="trendChart"></canvas></div></div>
    <div class="stats-section"><h3>üìñ Quran Pages Over Time</h3><div class="chart-container"><canvas id="quranChart"></canvas></div></div>
    <div class="stats-section"><h3>üìä Category Breakdown (Today)</h3><div id="categoryBreakdown"></div></div>
    <!-- Overall Stats -->
    <div class="stats-section"><h3>üìà Overall Progress</h3>
        <div class="stat-row"><span class="stat-label">Days Completed</span><span class="stat-value" id="statDaysCompleted">0 / 30</span></div>
        <div class="stat-row"><span class="stat-label">Average Completion</span><span class="stat-value" id="statAvgCompletion">0%</span></div>
        <div class="stat-row"><span class="stat-label">Total Points</span><span class="stat-value" id="statTotalPoints">0</span></div>
        <div class="stat-row"><span class="stat-label">Best Day</span><span class="stat-value" id="statBestDay">-</span></div>
        <div class="stat-row"><span class="stat-label">Perfect Days (100%)</span><span class="stat-value" id="statPerfectDays">0</span></div>
        <div class="stat-row"><span class="stat-label">Quran Pages Read</span><span class="stat-value" id="statQuranTotal">0 / 604</span></div>
    </div>
    <div class="stats-section"><h3>üèÖ Achievements (<span id="badgeCount">0</span>/12)</h3><div class="badges-grid" id="badgesGrid"></div></div>
    <div class="stats-section"><h3>üî• Best Streaks</h3>
        <div class="stat-row"><span class="stat-label">‚òÄÔ∏è Fajr</span><span class="stat-value" id="bestStreakFajr">0 days</span></div>
        <div class="stat-row"><span class="stat-label">üåô Night Prayer</span><span class="stat-value" id="bestStreakNight">0 days</span></div>
        <div class="stat-row"><span class="stat-label">üìñ Quran</span><span class="stat-value" id="bestStreakQuran">0 days</span></div>
        <div class="stat-row"><span class="stat-label">üíù Sadaqah</span><span class="stat-value" id="bestStreakCharity">0 days</span></div>
    </div>
</div>

<!-- MORE TAB -->
<div class="tab-content" id="tab-settings">
    <div class="stats-section"><h3>‚öôÔ∏è Settings</h3>
        <div class="setting-item"><div><div class="setting-label">Dark Mode</div><div class="setting-desc">Easier on eyes at night</div></div><button class="toggle-switch" id="darkModeToggle" onclick="toggleTheme()"></button></div>
    </div>
    <div class="stats-section"><h3>üìÑ Download Progress Report</h3>
        <p style="font-size:.88em;color:var(--text-secondary);margin-bottom:12px;line-height:1.5">Download a PDF summary of your Ramadan progress with charts, streaks, category breakdown, and all your data.</p>
        <button class="btn btn-gold" onclick="generatePDF()">üìÑ Download PDF Report</button>
    </div>
    <div class="stats-section"><h3>üíæ Data Management</h3>
        <button class="btn btn-outline" onclick="exportData()">üì§ Export Data (JSON)</button>
        <button class="btn btn-outline" onclick="document.getElementById('importInput').click()">üì• Import Data</button>
        <input type="file" id="importInput" accept=".json" onchange="importData(event)" style="display:none">
        <button class="btn btn-danger" onclick="confirmReset()">üóëÔ∏è Reset All Data</button>
    </div>
    <div class="stats-section"><h3>‚ÑπÔ∏è About</h3>
        <p style="color:var(--text-secondary);line-height:1.7;font-size:.88em"><strong>Ramadan Strivers</strong><br>From Muslim to Mu'min ‚Äî bringing out our best this Ramadan<br><br>Version 3.0<br>Works offline ¬∑ No account needed ¬∑ Data stored locally</p>
    </div>
    <div class="app-footer">
        <div class="dua">May Allah accept our fasting and deeds. Ramadan Mubarak! üåô</div>
        <p>For corrections, suggestions & feedback<br>please reach out to <a href="mailto:m.farhan.bava@gmail.com">Farhan</a></p>
        <p style="margin-top:8px;font-size:.78em;opacity:.6">Built with ‚ù§Ô∏è for the Ummah</p>
    </div>
</div>
</main>

<nav class="bottom-nav">
    <button class="nav-item active" data-tab="today" onclick="switchTab('today')"><span class="nav-icon">üìã</span><span class="nav-label">Today</span></button>
    <button class="nav-item" data-tab="calendar" onclick="switchTab('calendar')"><span class="nav-icon">üìÖ</span><span class="nav-label">Calendar</span></button>
    <button class="nav-item" data-tab="stats" onclick="switchTab('stats')"><span class="nav-icon">üìä</span><span class="nav-label">Stats</span></button>
    <button class="nav-item" data-tab="settings" onclick="switchTab('settings')"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-label">More</span></button>
</nav>

<div class="modal-overlay" id="dayModal">
    <div class="modal"><div class="modal-header"><h3 id="modalDayTitle">Day 1</h3><button class="modal-close" onclick="closeModal()">&times;</button></div><div class="modal-body" id="modalDayContent"></div></div>
</div>
<div class="toast-container" id="toastContainer"></div>

<script>
const TOTAL_QURAN_PAGES=604;
const PAGES_PER_JUZ=604/30;

const DAILY_HADITHS=[
{text:"Whoever fasts Ramadan out of faith and seeking reward, his previous sins will be forgiven.",source:"Bukhari 38",link:"https://sunnah.com/bukhari:38"},
{text:"When Ramadan begins, the gates of Paradise are opened and the gates of Hell are closed.",source:"Bukhari 1899",link:"https://sunnah.com/bukhari:1899"},
{text:"Fasting is a shield; so when one of you is fasting, let him not speak obscenely or act ignorantly.",source:"Bukhari 1894",link:"https://sunnah.com/bukhari:1894"},
{text:"There is a gate in Paradise called Ar-Rayyan, through which only those who fast will enter.",source:"Bukhari 1896",link:"https://sunnah.com/bukhari:1896"},
{text:"Whoever gives iftar to a fasting person will have the same reward without reducing theirs.",source:"Tirmidhi 807",link:"https://sunnah.com/tirmidhi:807"},
{text:"The supplication of the fasting person is not rejected.",source:"Ibn Majah 1753",link:"https://sunnah.com/ibnmajah:1753"},
{text:"Fasting and the Quran will intercede for the servant on the Day of Resurrection.",source:"Ahmad 6626",link:""},
{text:"Every action of the son of Adam is for him except fasting, for it is for Me and I shall reward it.",source:"Bukhari 1904",link:"https://sunnah.com/bukhari:1904"},
{text:"Whoever does not give up false speech, Allah has no need of him giving up food and drink.",source:"Bukhari 1903",link:"https://sunnah.com/bukhari:1903"},
{text:"Seek Laylatul Qadr in the odd nights of the last ten days of Ramadan.",source:"Bukhari 2017",link:"https://sunnah.com/bukhari:2017"},
{text:"The best charity is that given in Ramadan.",source:"Tirmidhi 663",link:"https://sunnah.com/tirmidhi:663"},
{text:"Whoever stands in prayer on Laylatul Qadr out of faith, his past sins will be forgiven.",source:"Bukhari 1901",link:"https://sunnah.com/bukhari:1901"},
{text:"The Prophet was the most generous in Ramadan when Jibreel would meet him.",source:"Bukhari 6",link:"https://sunnah.com/bukhari:6"},
{text:"Ramadan is the month of patience, and patience is rewarded with Paradise.",source:"Ibn Khuzaymah 1887",link:""},
{text:"When the last ten days began, the Prophet would tighten his waist belt and pray all night.",source:"Bukhari 2024",link:"https://sunnah.com/bukhari:2024"},
{text:"There is nothing equivalent to fasting.",source:"Nasai 2220",link:"https://sunnah.com/nasai:2220"},
{text:"The breath of a fasting person is sweeter to Allah than the scent of musk.",source:"Bukhari 1904",link:"https://sunnah.com/bukhari:1904"},
{text:"Whoever prays qiyam in Ramadan with faith and seeking reward will be forgiven.",source:"Bukhari 37",link:"https://sunnah.com/bukhari:37"},
{text:"Make dua to Allah with certainty that He will answer.",source:"Tirmidhi 3479",link:"https://sunnah.com/tirmidhi:3479"},
{text:"The strong is not the one who overcomes people, but who controls himself when angry.",source:"Bukhari 6114",link:"https://sunnah.com/bukhari:6114"},
{text:"Laylatul Qadr is better than a thousand months.",source:"Quran 97:3",link:""},
{text:"Whoever draws near to Allah with good character is like one who fasts and prays all night.",source:"Abu Dawud 4798",link:"https://sunnah.com/abudawud:4798"},
{text:"Allahumma innaka 'afuwwun tuhibbul 'afwa fa'fu 'anni ‚Äî O Allah, You are Pardoning‚Ä¶",source:"Tirmidhi 3513",link:"https://sunnah.com/tirmidhi:3513"},
{text:"The one who recites Quran skillfully is with the noble scribes (angels).",source:"Bukhari 4937",link:"https://sunnah.com/bukhari:4937"},
{text:"Allah extends His hand at night to accept repentance of those who sinned by day.",source:"Muslim 2759",link:"https://sunnah.com/muslim:2759"},
{text:"Whoever believes in Allah and the Last Day, let him speak good or remain silent.",source:"Bukhari 6018",link:"https://sunnah.com/bukhari:6018"},
{text:"Nothing is heavier on the Scale than good character.",source:"Tirmidhi 2003",link:"https://sunnah.com/tirmidhi:2003"},
{text:"The best of you are those who are best to their families.",source:"Tirmidhi 3895",link:"https://sunnah.com/tirmidhi:3895"},
{text:"Charity does not decrease wealth.",source:"Muslim 2588",link:"https://sunnah.com/muslim:2588"},
{text:"Whoever fasts Ramadan then follows it with six days of Shawwal, it is as if he fasted forever.",source:"Muslim 1164",link:"https://sunnah.com/muslim:1164"}
];

const BADGES=[
{id:'firstStep',name:'First Step',icon:'üå±',desc:'Complete day 1'},
{id:'weekOne',name:'Week One',icon:'üìÖ',desc:'Complete 7 days'},
{id:'halfway',name:'Halfway',icon:'üéØ',desc:'Complete 15 days'},
{id:'fajrWarrior',name:'Fajr Warrior',icon:'‚òÄÔ∏è',desc:'10-day Fajr streak'},
{id:'nightOwl',name:'Night Owl',icon:'ü¶â',desc:'10 Tahajjud prayers'},
{id:'quranLover',name:'Quran Lover',icon:'üìñ',desc:'20 days with Quran'},
{id:'generousHeart',name:'Generous',icon:'üíé',desc:'15 days with charity'},
{id:'abuBakrMedal',name:'Abu Bakr',icon:'ü•á',desc:'Complete challenge once'},
{id:'abuBakrGold',name:'Abu Bakr Gold',icon:'üèÜ',desc:'Challenge 5 times'},
{id:'lastTenHero',name:'Last 10 Hero',icon:'üåü',desc:'80%+ in last 10'},
{id:'perfectionist',name:'Perfectionist',icon:'‚ú®',desc:'3 perfect days'},
{id:'champion',name:'Champion',icon:'üëë',desc:'All 30 days 70%+'}
];

const CHECKLIST_DATA=[
{id:'salah',title:'1. SALAH, SUNNAH & DHIKR',
hadithNote:'"Whoever attends Isha in congregation has the reward of standing half the night. And whoever prays Isha and Fajr in congregation has the reward of standing the entire night." ‚Äî Muslim 656',
subcategories:[
{name:'üåÖ Fajr & Morning',items:[
{id:'fajr-sunnah',label:'2 Sunnah before Fajr',ref:'Muslim 724',refLink:'https://sunnah.com/muslim:724',explanation:'Better than the world and all it contains.',points:8},
{id:'fajr',label:'Fajr prayer',ref:'Bukhari 555',refLink:'https://sunnah.com/bukhari:555',explanation:'Foundation of the day; the angels of night and day witness it.',points:15,streak:'fajr'},
{id:'morning-adhkar',label:'Morning adhkar',ref:'Abu Dawud 5068',refLink:'https://sunnah.com/abudawud:5068',explanation:'Prophetic protection until evening.',points:5,appLink:'lifewithallah'},
{id:'istighfar',label:'Istighfar (seek forgiveness)',ref:'Bukhari 6307',refLink:'https://sunnah.com/bukhari:6307',explanation:'The Prophet Ô∑∫ sought forgiveness more than 70 times daily.',points:5},
{id:'salawat',label:'Salawat upon the Prophet Ô∑∫',ref:'Muslim 408',refLink:'https://sunnah.com/muslim:408',explanation:'One salawat brings ten blessings from Allah.',points:5},
{id:'duha',label:'Duha prayer (2‚Äì8 rakahs)',ref:'Muslim 720',refLink:'https://sunnah.com/muslim:720',explanation:'Charity for every joint in your body.',points:5}
]},
{name:'‚òÄÔ∏è Dhuhr & Asr',items:[
{id:'dhuhr-sunnah-before',label:'4 Sunnah before Dhuhr',ref:'Tirmidhi 428',refLink:'https://sunnah.com/tirmidhi:428',explanation:'Regular Sunnah of the Prophet Ô∑∫.',points:8},
{id:'dhuhr',label:'Dhuhr prayer',ref:'Quran 17:78',refLink:'',explanation:'Midday obligation ‚Äî establishes rhythm of worship.',points:15},
{id:'dhuhr-sunnah-after',label:'2 Sunnah after Dhuhr',ref:'Tirmidhi 428',refLink:'https://sunnah.com/tirmidhi:428',explanation:'Twelve daily Sunnah rakahs earn a house in Jannah.',points:8},
{id:'asr',label:'Asr prayer',ref:'Bukhari 553',refLink:'https://sunnah.com/bukhari:553',explanation:'Guarding Asr is specifically emphasised.',points:15}
]},
{name:'üåá Maghrib & Evening',items:[
{id:'dua-iftar',label:'Dua at iftar',ref:'Abu Dawud 2357',refLink:'https://sunnah.com/abudawud:2357',explanation:'The dua of the fasting person at iftar is not rejected.',points:5},
{id:'maghrib',label:'Maghrib prayer',ref:'Bukhari 560',refLink:'https://sunnah.com/bukhari:560',explanation:'Marks the breaking of fast.',points:15},
{id:'maghrib-sunnah',label:'2 Sunnah after Maghrib',ref:'Bukhari 1183',refLink:'https://sunnah.com/bukhari:1183',explanation:'Prayed regularly by the Prophet Ô∑∫.',points:8},
{id:'evening-adhkar',label:'Evening adhkar',ref:'Abu Dawud 5068',refLink:'https://sunnah.com/abudawud:5068',explanation:'Prophetic protection until morning.',points:5,appLink:'lifewithallah'}
]},
{name:'üåô Isha & Night',items:[
{id:'isha',label:'Isha prayer',ref:'Muslim 656',refLink:'https://sunnah.com/muslim:656',explanation:'Praying Isha and Fajr in congregation equals standing the whole night.',points:15},
{id:'isha-sunnah',label:'2 Sunnah after Isha',ref:'Muslim 728',refLink:'https://sunnah.com/muslim:728',explanation:'Established Sunnah ‚Äî completes the night prayers.',points:8},
{id:'tarawih',label:'Tarawih',ref:'Bukhari 2009',refLink:'https://sunnah.com/bukhari:2009',explanation:'Forgiveness of past sins ‚Äî unique to Ramadan.',points:10,streak:'night'},
{id:'witr',label:'Witr (1 or 3 rakahs)',ref:'Bukhari 998',refLink:'https://sunnah.com/bukhari:998',explanation:'Make it your last prayer of the night.',points:8},
{id:'night-adhkar',label:'Night adhkar before sleep',ref:'Bukhari 6320',refLink:'https://sunnah.com/bukhari:6320',explanation:'Ayatul Kursi, last 2 ayat of Baqarah ‚Äî protection through the night.',points:5,appLink:'lifewithallah'},
{id:'tahajjud',label:'Tahajjud (last third of night)',ref:'Bukhari 1145',refLink:'https://sunnah.com/bukhari:1145',explanation:'Allah descends and asks: "Who calls upon Me that I may answer?"',points:10,streak:'night'},
{id:'dua-night',label:'Dua in last third of night',ref:'Bukhari 1145',refLink:'https://sunnah.com/bukhari:1145',explanation:'The most blessed time for supplication ‚Äî Allah answers.',points:5}
]}
]},
{id:'quran',title:'2. QURAN ‚Äî UNDERSTAND & IMPLEMENT',
hadithNote:'"Fasting and the Quran will intercede for a servant on the Day of Resurrection." ‚Äî Ahmad 6626',
items:[
{id:'quran-recitation',label:'Quran recitation (daily portion)',ref:'Quran 2:185',refLink:'',explanation:'Ramadan is the month of Quran ‚Äî recite your daily pages.',points:10,streak:'quran',appLink:'tarteel'},
{id:'quran-reflection',label:'Reflected on meaning (tadabbur)',ref:'Quran 38:29',refLink:'',explanation:'Pondering deeply transforms the heart and guides action.',points:10,streak:'quran'},
{id:'quran-implementation',label:'Applied a lesson from today\'s reading',ref:'Quran 2:44',refLink:'',explanation:'Knowledge without action is incomplete. Implement what you learn.',points:10},
{id:'quran-listening',label:'Listened to Quran recitation',ref:'Quran 7:204',refLink:'',explanation:'Listen and be silent so that you may receive mercy.',points:5,streak:'quran',appLink:'tarteel'},
{id:'quran-memorization',label:'Memorised new ayah(s)',ref:'Bukhari 5027',refLink:'https://sunnah.com/bukhari:5027',explanation:'The best of you are those who learn the Quran and teach it.',points:10}
]},
{id:'character',title:'3. INTENTION, HEART & CHARACTER',
hadithNote:'"Actions are judged by intentions, and every person will get what they intended." ‚Äî Bukhari 1',
items:[
{id:'intention',label:'Renewed intention (ikhlas)',ref:'Bukhari 1',refLink:'https://sunnah.com/bukhari:1',explanation:'Every action takes its value from the heart.',points:7},
{id:'riya',label:'Checked and corrected riya',ref:'Muslim 2985',refLink:'https://sunnah.com/muslim:2985',explanation:'Riya quietly voids reward. Train private sincerity.',points:7},
{id:'tongue',label:'Guarded the tongue',ref:'Bukhari 1903',refLink:'https://sunnah.com/bukhari:1903',explanation:'Fasting disciplines speech as much as hunger.',points:7},
{id:'arguments',label:'Avoided arguments while fasting',ref:'Bukhari 1894',refLink:'https://sunnah.com/bukhari:1894',explanation:'If insulted, say "I am fasting."',points:7},
{id:'gaze',label:'Lowered the gaze',ref:'Quran 24:30',refLink:'',explanation:'What the eyes consume shapes the heart.',points:7},
{id:'anger',label:'Controlled anger',ref:'Bukhari 6114',refLink:'https://sunnah.com/bukhari:6114',explanation:'The strong one controls himself when angry.',points:7},
{id:'gentleness',label:'Chose gentleness in interactions',ref:'Tirmidhi 2003',refLink:'https://sunnah.com/tirmidhi:2003',explanation:'Nothing is heavier on the Scale than good character.',points:7},
{id:'mercy',label:'Showed mercy to others',ref:'Tirmidhi 1924',refLink:'https://sunnah.com/tirmidhi:1924',explanation:'The Merciful shows mercy to those who show mercy.',points:7},
{id:'humility',label:'Practised humility',ref:'Muslim 2588',refLink:'https://sunnah.com/muslim:2588',explanation:'Whoever humbles himself for Allah, Allah will raise him.',points:7},
{id:'forgave',label:'Forgave someone',ref:'Quran 42:43',refLink:'',explanation:'Whoever pardons and reconciles, his reward is with Allah.',points:7},
{id:'dua-absence',label:'Made dua for someone in their absence',ref:'Muslim 2733',refLink:'https://sunnah.com/muslim:2733',explanation:'An angel says: "Amin, and for you the same."',points:7},
{id:'made-happy',label:'Made someone happy for Allah\'s sake',ref:'Tabarani (Mu\'jam al-Awsat)',refLink:'',explanation:'The most beloved deeds include bringing joy to a believer.',points:7}
]},
{id:'charity',title:'4. CHARITY & SERVICE',
hadithNote:'"The Prophet Ô∑∫ was the most generous of people, and he was most generous in Ramadan." ‚Äî Bukhari 6',
items:[
{id:'charity-given',label:'Gave charity (any amount)',ref:'Muslim 2588',refLink:'https://sunnah.com/muslim:2588',explanation:'Charity does not decrease wealth. Value lies in sincerity, not size.',points:10,streak:'charity'},
{id:'fed-fasting',label:'Fed someone who was fasting',ref:'Tirmidhi 807',refLink:'https://sunnah.com/tirmidhi:807',explanation:'You receive the same reward as the fasting person.',points:10,streak:'charity'},
{id:'helped-family',label:'Served or helped parents/family',ref:'Bukhari 5970',refLink:'https://sunnah.com/bukhari:5970',explanation:'The best of deeds after prayer is kindness to parents.',points:10},
{id:'maintained-ties',label:'Maintained ties of kinship',ref:'Muslim 2557',refLink:'https://sunnah.com/muslim:2557',explanation:'Whoever maintains family ties, Allah maintains ties with him.',points:7},
{id:'visited-sick',label:'Visited or supported the sick',ref:'Muslim 2568',refLink:'https://sunnah.com/muslim:2568',explanation:'Whoever visits a sick person remains in the harvest of Paradise.',points:10},
{id:'dua-others',label:'Made dua for others privately',ref:'Muslim 2733',refLink:'https://sunnah.com/muslim:2733',explanation:'An angel says: "Amin, and for you the same."',points:7}
]},
{id:'lastTen',title:'5. LAST TEN NIGHTS ‚Äî SEEK LAYLATUL QADR',lastTen:true,
hadithNote:'"Seek Laylatul Qadr in the odd nights of the last ten days." ‚Äî Bukhari 2017. "Whoever stands in prayer on Laylatul Qadr out of faith, his past sins will be forgiven." ‚Äî Bukhari 1901. Laylatul Qadr is better than 1,000 months (~83 years). It could be ANY of the last ten nights ‚Äî strive every single night.',
items:[
{id:'laylat-qadr',label:'Sought Laylat al-Qadr tonight',ref:'Quran 97:3',refLink:'',explanation:'Better than 1,000 months of worship. Strive every night ‚Äî you don\'t know which one it is.',points:15},
{id:'extra-dua',label:'Allahumma innaka \'afuwwun tuhibbul \'afwa fa\'fu \'anni',ref:'Tirmidhi 3513',refLink:'https://sunnah.com/tirmidhi:3513',explanation:'The dua the Prophet Ô∑∫ taught Aishah for Laylatul Qadr.',points:10},
{id:'extra-quran',label:'Extra Quran recitation',ref:'Bukhari 4997',refLink:'https://sunnah.com/bukhari:4997',explanation:'The Prophet Ô∑∫ intensified Quran in the last ten.',points:10},
{id:'night-charity',label:'Night charity (hidden sadaqah)',ref:'Bukhari 1423',refLink:'https://sunnah.com/bukhari:1423',explanation:'Hidden charity ‚Äî his left hand does not know what his right gives.',points:10},
{id:'long-sujood',label:'Extra long sujood with dua',ref:'Muslim 482',refLink:'https://sunnah.com/muslim:482',explanation:'The closest a servant is to Allah is in sujood.',points:10},
{id:'dua-list',label:'Personal dua list ‚Äî recited with conviction',ref:'',refLink:'',explanation:'Prepare your requests for these blessed nights.',points:5},
{id:'itikaf',label:'I\'tikaf (even partial)',ref:'Bukhari 2025',refLink:'https://sunnah.com/bukhari:2025',explanation:'The Prophet Ô∑∫ observed I\'tikaf in the last ten days every Ramadan.',points:15}
]},
{id:'endOfDay',title:'6. END-OF-DAY REVIEW',items:[
{id:'istighfar-sleep',label:'Istighfar before sleep',ref:'Bukhari 6307',refLink:'https://sunnah.com/bukhari:6307',explanation:'End the day with a clean slate.',points:5},
{id:'accountability',label:'Self-accountability (muhasaba)',ref:'Quran 59:18',refLink:'',explanation:'"Let every soul look to what it has sent forth for tomorrow."',points:5},
{id:'renew-tomorrow',label:'Renewed intention for tomorrow',ref:'Bukhari 6464',refLink:'https://sunnah.com/bukhari:6464',explanation:'The most beloved deeds to Allah are the most consistent.',points:5},
{id:'sleep-early',label:'Slept early for Fajr',ref:'Abu Dawud 4723',refLink:'https://sunnah.com/abudawud:4723',explanation:'The Prophet Ô∑∫ disliked talking after Isha. Protect your Fajr.',points:5}
]},
{id:'avoidance',title:'7. DAILY AVOIDANCE CHECK',
hadithNote:'"Whoever does not give up false speech and acting upon it, Allah has no need of him giving up his food and drink." ‚Äî Bukhari 1903',
items:[
{id:'no-lying',label:'No lying',ref:'Bukhari 1903',refLink:'https://sunnah.com/bukhari:1903',explanation:'False speech nullifies the spiritual reward of fasting.',points:5},
{id:'no-backbiting',label:'No backbiting (gheebah)',ref:'Quran 49:12',refLink:'',explanation:'Like eating the flesh of your dead brother.',points:5},
{id:'no-riya',label:'No showing off (riya)',ref:'Muslim 2985',refLink:'https://sunnah.com/muslim:2985',explanation:'Deeds done for show are rejected.',points:5},
{id:'no-excess-media',label:'No excessive social media',ref:'Quran 23:3',refLink:'',explanation:'The believers turn away from ill speech.',points:5},
{id:'no-useless-scrolling',label:'No useless scrolling',ref:'Tirmidhi 2416',refLink:'https://sunnah.com/tirmidhi:2416',explanation:'You will be asked about your time.',points:5},
{id:'no-haram-content',label:'No music/inappropriate content',ref:'Quran 17:36',refLink:'',explanation:'The hearing, sight and heart will all be questioned.',points:5},
{id:'no-overeating',label:'No overeating at iftar',ref:'Tirmidhi 2380',refLink:'https://sunnah.com/tirmidhi:2380',explanation:'One-third food, one-third water, one-third air.',points:5},
{id:'no-wasting-food',label:'No wasting food',ref:'Quran 7:31',refLink:'',explanation:'Allah does not love the wasteful.',points:5},
{id:'no-neglect-salah',label:'No neglecting prayers',ref:'Quran 19:59',refLink:'',explanation:'There came successors who neglected prayer and pursued desires.',points:5}
]},
{id:'abuBakr',title:'8. ABU BAKR CHALLENGE ‚≠ê',
hadithNote:'The Prophet Ô∑∫ asked four questions. Abu Bakr answered "I did" to all. The Prophet Ô∑∫ said: "Whoever combines these will enter Jannah." ‚Äî Muslim 1028',
items:[
{id:'abu-bakr-fasting',label:'"Who among you is fasting today?" ‚Äî I am.',ref:'Muslim 1028',refLink:'https://sunnah.com/muslim:1028',explanation:'',points:10,abuBakr:true},
{id:'abu-bakr-funeral',label:'"Who attended a funeral?" ‚Äî I did.',ref:'Muslim 1028',refLink:'https://sunnah.com/muslim:1028',explanation:'Praying janazah or making dua for the deceased.',points:10,abuBakr:true},
{id:'abu-bakr-fed',label:'"Who fed a poor person?" ‚Äî I did.',ref:'Muslim 1028',refLink:'https://sunnah.com/muslim:1028',explanation:'Even a small meal or date counts.',points:10,abuBakr:true},
{id:'abu-bakr-sick',label:'"Who visited a sick person?" ‚Äî I did.',ref:'Muslim 1028',refLink:'https://sunnah.com/muslim:1028',explanation:'A visit, call, or message of support.',points:10,abuBakr:true}
]}
];

// STATE
let APP_STATE={currentDay:1,theme:'dark',activeTab:'today'};
let quranPages={};
let trendChartInst=null,quranChartInst=null;
let deferredPrompt=null;

// INIT
document.addEventListener('DOMContentLoaded',()=>{
    loadSettings();renderChecklist();loadTodayData();updateUI();updateQuranTracker();
    renderCalendar();renderHeatmap();renderBadges();updateStats();registerSW();checkInstall();
});

// SETTINGS
function loadSettings(){
    const s=localStorage.getItem('rs-settings');if(s){APP_STATE={...APP_STATE,...JSON.parse(s)};}
    document.documentElement.setAttribute('data-theme',APP_STATE.theme);updateThemeUI();
    const qp=localStorage.getItem('rs-quran-pages');if(qp)quranPages=JSON.parse(qp);
}
function saveSettings(){localStorage.setItem('rs-settings',JSON.stringify({currentDay:APP_STATE.currentDay,theme:APP_STATE.theme}));}

// DAY NAV
function changeDay(d){const n=APP_STATE.currentDay+d;if(n>=1&&n<=30){saveTodayData();APP_STATE.currentDay=n;saveSettings();renderChecklist();loadTodayData();updateUI();updateQuranTracker();}}

// THEME
function toggleTheme(){APP_STATE.theme=APP_STATE.theme==='light'?'dark':'light';document.documentElement.setAttribute('data-theme',APP_STATE.theme);updateThemeUI();saveSettings();}
function updateThemeUI(){document.getElementById('themeIcon').textContent=APP_STATE.theme==='dark'?'‚òÄÔ∏è':'üåô';const t=document.getElementById('darkModeToggle');if(t)t.classList.toggle('active',APP_STATE.theme==='dark');}

// NAV
function switchTab(tab){APP_STATE.activeTab=tab;document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));document.getElementById(`tab-${tab}`).classList.add('active');document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));document.querySelector(`[data-tab="${tab}"]`).classList.add('active');if(tab==='stats'){updateStats();renderCharts();updateComparison();}if(tab==='calendar'){renderCalendar();renderHeatmap();}}

// UI
function isLast10(){return APP_STATE.currentDay>=21;}
function isOddNight(){return isLast10()&&[21,23,25,27,29].includes(APP_STATE.currentDay);}
function updateUI(){
    document.getElementById('currentDay').textContent=APP_STATE.currentDay;
    document.getElementById('dayDisplay').textContent=`Day ${APP_STATE.currentDay} / 30`;
    const b=document.getElementById('dayBanner');b.classList.toggle('last-ten',isLast10());
    const h=DAILY_HADITHS[APP_STATE.currentDay-1];
    const hl=h.link?`<a href="${h.link}" target="_blank" rel="noopener" style="color:inherit">${h.source}</a>`:h.source;
    document.getElementById('dailyHadith').innerHTML=`"${h.text}" ‚Äî <em>${hl}</em>`;
    const ob=document.getElementById('oddNightBadge');
    ob.innerHTML=isOddNight()?'<div class="odd-night-badge">üåô Seek Laylatul Qadr Tonight!</div>':'';
    const ltm=document.getElementById('lastTenMsg');
    if(isLast10()&&!isOddNight())ltm.innerHTML='<div class="last-ten-message">üî• Last 10 Nights ‚Äî strive every night, Laylatul Qadr could be tonight!</div>';
    else ltm.innerHTML='';
    const lts=document.querySelector('[data-section="lastTen"]');
    if(lts){lts.style.display=isLast10()?'block':'none';if(isLast10())lts.classList.add('last-ten-section');}
}

// QURAN TRACKER
function logQuranPages(){
    const input=document.getElementById('quranPagesInput');const val=parseInt(input.value);
    if(isNaN(val)||val<0){showToast('Please enter a valid number');return;}
    quranPages[APP_STATE.currentDay]=val;localStorage.setItem('rs-quran-pages',JSON.stringify(quranPages));
    input.value='';showToast(`${val} pages logged for Day ${APP_STATE.currentDay}! üìñ`);updateQuranTracker();
    const cb=document.getElementById('quran-recitation');if(cb&&!cb.checked&&val>0){cb.checked=true;handleCheckboxChange();}
}
function updateQuranTracker(){
    let totalRead=0;for(let d=1;d<=30;d++){if(quranPages[d])totalRead+=quranPages[d];}
    const pagesLeft=Math.max(0,TOTAL_QURAN_PAGES-totalRead);
    const daysLeft=Math.max(1,30-APP_STATE.currentDay+1);
    const perDay=pagesLeft>0?Math.ceil(pagesLeft/daysLeft):0;
    const pct=Math.min(100,Math.round((totalRead/TOTAL_QURAN_PAGES)*100));
    const currentJuz=Math.min(30,Math.floor(totalRead/PAGES_PER_JUZ)+1);
    document.getElementById('quranPagesRead').textContent=totalRead;
    document.getElementById('quranPagesLeft').textContent=pagesLeft;
    document.getElementById('quranDaysLeft').textContent=daysLeft;
    document.getElementById('quranPagesPerDay').textContent=pagesLeft===0?'‚úÖ Done!':`~${perDay}`;
    document.getElementById('quranProgressFill').style.width=pct+'%';
    document.getElementById('quranJuz').textContent=pagesLeft===0?'‚úÖ Complete!':`Juz ${currentJuz} / 30`;
    const el=document.getElementById('quranMessage');
    if(totalRead===0)el.textContent='Read, understand, and implement ‚Äî even one ayah a day transforms your life.';
    else if(pct>=100)el.textContent='Alhamdulillah! Quran completed. Now revisit, reflect deeply, and live by its guidance.';
    else if(pct>=75)el.textContent=`Almost there! ${pagesLeft} pages left. Don't just finish ‚Äî understand each ayah and implement it.`;
    else if(pct>=50)el.textContent=`Over halfway! ${perDay} pages/day will get you there. Focus on quality ‚Äî understand and apply.`;
    else el.textContent=`${pagesLeft} pages remaining (~${perDay}/day). Read with tadabbur ‚Äî ponder, understand, and live by it.`;
    const sq=document.getElementById('statQuranTotal');if(sq)sq.textContent=`${totalRead} / 604`;
    const inp=document.getElementById('quranPagesInput');
    if(inp)inp.placeholder=quranPages[APP_STATE.currentDay]?`Today: ${quranPages[APP_STATE.currentDay]} pages`:'Pages read today';
}

// CHECKLIST
function getAllItems(){const items=[];CHECKLIST_DATA.forEach(s=>{if(s.subcategories)s.subcategories.forEach(sub=>sub.items.forEach(i=>items.push(i)));if(s.items)s.items.forEach(i=>items.push(i));});return items;}
function renderChecklist(){
    const c=document.getElementById('checklistContainer');c.innerHTML='';
    CHECKLIST_DATA.forEach(sec=>{
        if(sec.lastTen&&!isLast10())return;
        const el=document.createElement('div');el.className='section';el.setAttribute('data-section',sec.id);
        if(sec.lastTen)el.classList.add('last-ten-section');
        const total=sec.subcategories?sec.subcategories.reduce((a,s)=>a+s.items.length,0):(sec.items?sec.items.length:0);
        let html=`<div class="section-header" onclick="toggleSection('${sec.id}')"><h2>${sec.title}</h2><div class="section-progress"><span class="section-progress-text" id="progress-${sec.id}">0/${total}</span><span class="toggle-icon">‚ñº</span></div></div><div class="section-content">`;
        if(sec.hadithNote)html+=`<div class="hadith-note">${sec.hadithNote}</div>`;
        if(sec.subcategories)sec.subcategories.forEach(sub=>{html+=`<div class="subsection-title">${sub.name}</div>`;sub.items.forEach(i=>{html+=renderItem(i);});});
        if(sec.items)sec.items.forEach(i=>{html+=renderItem(i);});
        html+=`</div>`;el.innerHTML=html;c.appendChild(el);
    });
}
function renderItem(item){
    const refLink=item.refLink?`<a href="${item.refLink}" target="_blank" rel="noopener">${item.ref}</a>`:item.ref;
    let appHtml='';
    if(item.appLink==='lifewithallah')appHtml=`<a href="https://lifewithallah.com/app" target="_blank" rel="noopener" class="app-inline-link"><span class="ail-icon">ü§≤</span><span class="ail-text"><strong>Life with Allah</strong> ‚Äî Authentic adhkar & duas app</span><span class="ail-arrow">‚Üí</span></a>`;
    if(item.appLink==='tarteel')appHtml=`<a href="https://tarteel.ai/" target="_blank" rel="noopener" class="app-inline-link"><span class="ail-icon">üìñ</span><span class="ail-text"><strong>Tarteel AI</strong> ‚Äî AI Quran recitation & memorisation</span><span class="ail-arrow">‚Üí</span></a>`;
    return `<div class="checklist-item" id="item-${item.id}"><input type="checkbox" id="${item.id}" onchange="handleCheckboxChange()"><label for="${item.id}">${item.label} <span class="item-points">+${item.points}</span>${item.ref?`<span class="reference">${refLink}</span>`:''}${item.explanation?`<span class="explanation">${item.explanation}</span>`:''}</label></div>${appHtml}`;
}
function toggleSection(id){document.querySelector(`[data-section="${id}"]`).classList.toggle('collapsed');}
function handleCheckboxChange(){saveTodayData();updateProgress();updateStreaks();checkBadges();updateStats();}

// DATA
function getTodayKey(){return `rs-day-${APP_STATE.currentDay}`;}
function saveTodayData(){
    const cbs=document.querySelectorAll('.checklist-item input[type="checkbox"]');
    const data={dayNumber:APP_STATE.currentDay,checklist:{},lastUpdated:Date.now()};
    let pts=0,completed=0,total=0;
    cbs.forEach(cb=>{data.checklist[cb.id]=cb.checked;if(cb.checked){const it=findItem(cb.id);if(it)pts+=it.points;completed++;}total++;});
    if(isLast10())pts=Math.floor(pts*(isOddNight()?3:2));
    data.completedCount=completed;data.totalCount=total;data.percentage=total>0?Math.round((completed/total)*100):0;data.points=pts;
    localStorage.setItem(getTodayKey(),JSON.stringify(data));return data;
}
function loadTodayData(){const s=localStorage.getItem(getTodayKey());if(s){const d=JSON.parse(s);Object.keys(d.checklist).forEach(id=>{const cb=document.getElementById(id);if(cb){cb.checked=d.checklist[id];updateItemUI(id);}});}updateProgress();updateStreaks();}
function getDayData(n){const s=localStorage.getItem(`rs-day-${n}`);return s?JSON.parse(s):null;}
function findItem(id){for(const sec of CHECKLIST_DATA){if(sec.subcategories)for(const sub of sec.subcategories)for(const it of sub.items)if(it.id===id)return it;if(sec.items)for(const it of sec.items)if(it.id===id)return it;}return null;}
function updateItemUI(id){const cb=document.getElementById(id);const el=document.getElementById(`item-${id}`);if(cb&&el)el.classList.toggle('checked',cb.checked);}

// PROGRESS
function updateProgress(){
    const cbs=document.querySelectorAll('.checklist-item input[type="checkbox"]');let completed=0,total=0,pts=0;
    cbs.forEach(cb=>{total++;if(cb.checked){completed++;const it=findItem(cb.id);if(it)pts+=it.points;}updateItemUI(cb.id);});
    if(isLast10())pts=Math.floor(pts*(isOddNight()?3:2));
    const pct=total>0?Math.round((completed/total)*100):0;
    document.getElementById('progressPercent').textContent=pct+'%';document.getElementById('progressBar').style.width=pct+'%';
    document.getElementById('progressCount').textContent=`${completed} of ${total} completed`;document.getElementById('todayPoints').textContent=pts;
    CHECKLIST_DATA.forEach(sec=>{if(sec.lastTen&&!isLast10())return;let sc=0,st=0;if(sec.subcategories)sec.subcategories.forEach(sub=>sub.items.forEach(it=>{st++;const cb=document.getElementById(it.id);if(cb&&cb.checked)sc++;}));if(sec.items)sec.items.forEach(it=>{st++;const cb=document.getElementById(it.id);if(cb&&cb.checked)sc++;});const el=document.getElementById(`progress-${sec.id}`);if(el)el.textContent=`${sc}/${st}`;});
}

// STREAKS
function calculateStreak(fn){let s=0;for(let d=APP_STATE.currentDay-1;d>=1;d--){const x=getDayData(d);if(x&&fn(x))s++;else break;}const td=getDayData(APP_STATE.currentDay);if(td&&fn(td))s++;else if(fn({checklist:getCurrentChecklist()}))s++;return s;}
function getCurrentChecklist(){const c={};document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(cb=>c[cb.id]=cb.checked);return c;}
function updateStreaks(){
    const fs=calculateStreak(d=>d.checklist&&d.checklist['fajr']);const ns=calculateStreak(d=>d.checklist&&(d.checklist['tarawih']||d.checklist['tahajjud']));
    const qs=calculateStreak(d=>d.checklist&&(d.checklist['quran-recitation']||d.checklist['quran-reflection']||d.checklist['quran-listening']));
    const cs=calculateStreak(d=>d.checklist&&(d.checklist['charity-given']||d.checklist['fed-fasting']));
    document.getElementById('streakFajrCount').textContent=fs;document.getElementById('streakNightCount').textContent=ns;
    document.getElementById('streakQuranCount').textContent=qs;document.getElementById('streakCharityCount').textContent=cs;
    ['Fajr','Night','Quran','Charity'].forEach((n,i)=>{const v=[fs,ns,qs,cs][i];document.getElementById(`streak${n}`).classList.toggle('active',v>0);});
    saveBestStreaks({fajr:fs,night:ns,quran:qs,charity:cs});
}
function saveBestStreaks(c){const s=JSON.parse(localStorage.getItem('rs-best-streaks')||'{}');const u={fajr:Math.max(s.fajr||0,c.fajr),night:Math.max(s.night||0,c.night),quran:Math.max(s.quran||0,c.quran),charity:Math.max(s.charity||0,c.charity)};localStorage.setItem('rs-best-streaks',JSON.stringify(u));}
function getBestStreaks(){return JSON.parse(localStorage.getItem('rs-best-streaks')||'{"fajr":0,"night":0,"quran":0,"charity":0}');}

// BADGES
function renderBadges(){const grid=document.getElementById('badgesGrid');const ul=getUnlockedBadges();grid.innerHTML=BADGES.map(b=>`<div class="badge-item ${ul[b.id]?'unlocked':'locked'}"><div class="badge-icon">${b.icon}</div><div class="badge-name">${b.name}</div></div>`).join('');document.getElementById('badgeCount').textContent=Object.values(ul).filter(v=>v).length;}
function getUnlockedBadges(){return JSON.parse(localStorage.getItem('rs-badges')||'{}');}
function unlockBadge(id){const b=getUnlockedBadges();if(!b[id]){b[id]={unlocked:true,date:new Date().toISOString()};localStorage.setItem('rs-badges',JSON.stringify(b));const badge=BADGES.find(x=>x.id===id);if(badge)showToast(`${badge.icon} Badge: ${badge.name}!`,'badge');renderBadges();}}
function checkBadges(){
    const td=saveTodayData();if(APP_STATE.currentDay===1&&td.percentage>0)unlockBadge('firstStep');
    let dp=0;for(let d=1;d<=7;d++){const x=getDayData(d);if(x&&x.percentage>0)dp++;}if(dp>=7)unlockBadge('weekOne');
    dp=0;for(let d=1;d<=15;d++){const x=getDayData(d);if(x&&x.percentage>0)dp++;}if(dp>=15)unlockBadge('halfway');
    if(calculateStreak(d=>d.checklist&&d.checklist['fajr'])>=10)unlockBadge('fajrWarrior');
    let tc=0;for(let d=1;d<=30;d++){const x=getDayData(d);if(x&&x.checklist&&x.checklist['tahajjud'])tc++;}if(tc>=10)unlockBadge('nightOwl');
    let qd=0;for(let d=1;d<=30;d++){const x=getDayData(d);if(x&&x.checklist&&(x.checklist['quran-recitation']||x.checklist['quran-reflection']))qd++;}if(qd>=20)unlockBadge('quranLover');
    let cd=0;for(let d=1;d<=30;d++){const x=getDayData(d);if(x&&x.checklist&&(x.checklist['charity-given']||x.checklist['fed-fasting']))cd++;}if(cd>=15)unlockBadge('generousHeart');
    const abi=['abu-bakr-fasting','abu-bakr-funeral','abu-bakr-fed','abu-bakr-sick'];let abc=0;
    for(let d=1;d<=30;d++){const x=getDayData(d);if(x&&x.checklist&&abi.every(i=>x.checklist[i])){unlockBadge('abuBakrMedal');abc++;}}if(abc>=5)unlockBadge('abuBakrGold');
    let pd=0;for(let d=1;d<=30;d++){const x=getDayData(d);if(x&&x.percentage===100)pd++;}if(pd>=3)unlockBadge('perfectionist');
    if(APP_STATE.currentDay>=30){let lt=0,ld=0;for(let d=21;d<=30;d++){const x=getDayData(d);if(x){lt+=x.percentage;ld++;}}if(ld===10&&(lt/10)>=80)unlockBadge('lastTenHero');let q=0;for(let d=1;d<=30;d++){const x=getDayData(d);if(x&&x.percentage>=70)q++;}if(q===30)unlockBadge('champion');}
}

// HEATMAP
function renderHeatmap(){
    const g=document.getElementById('heatmapGrid');g.innerHTML='';
    for(let d=1;d<=30;d++){const data=getDayData(d);let lvl=0;
        if(data){if(data.percentage>=76)lvl=4;else if(data.percentage>=51)lvl=3;else if(data.percentage>=26)lvl=2;else if(data.percentage>0)lvl=1;}
        const cell=document.createElement('div');
        cell.className=`heatmap-cell l${lvl}${d===APP_STATE.currentDay?' today-cell':''}`;
        cell.title=`Day ${d}: ${data?data.percentage+'%':'No data'}`;
        cell.onclick=()=>showDayModal(d);g.appendChild(cell);
    }
}

// CALENDAR
function renderCalendar(){
    const g=document.getElementById('calendarGrid');g.innerHTML='';
    for(let d=1;d<=30;d++){const data=getDayData(d);const isToday=d===APP_STATE.currentDay;const isOdd=d>=21&&[21,23,25,27,29].includes(d);
        let cc='',pct='-';if(data){pct=data.percentage+'%';if(data.percentage>=76)cc='completed-high';else if(data.percentage>=51)cc='completed-med';else if(data.percentage>0)cc='completed-low';}
        const el=document.createElement('div');el.className=`calendar-day ${cc} ${isToday?'today':''} ${isOdd?'odd-night':''}`;
        el.innerHTML=`<div class="calendar-day-number">${d}</div><div class="calendar-day-percent">${pct}</div>`;el.onclick=()=>showDayModal(d);g.appendChild(el);
    }
}
function showDayModal(day){
    document.getElementById('modalDayTitle').textContent=`Day ${day} of Ramadan`;const data=getDayData(day);let content='';
    if(data){const qp=quranPages[day]||0;
        content=`<div style="text-align:center;margin-bottom:20px"><div style="font-size:2.5em;font-weight:700;color:var(--accent-green);font-family:var(--font-display)">${data.percentage}%</div><div style="color:var(--text-muted)">${data.completedCount} of ${data.totalCount} completed</div><div style="color:var(--accent-gold);font-weight:600;margin-top:5px">üî• ${data.points} points</div>${qp>0?`<div style="color:var(--accent-green);margin-top:5px">üìñ ${qp} Quran pages</div>`:''}</div><h4 style="margin-bottom:10px;color:var(--accent-green);font-family:var(--font-display)">Completed:</h4><div style="max-height:300px;overflow-y:auto">${Object.entries(data.checklist).filter(([,c])=>c).map(([id])=>{const it=findItem(id);return it?`<div style="padding:6px 0;border-bottom:1px solid var(--border-color);font-size:.88em">‚úÖ ${it.label}</div>`:''}).join('')||'<p style="color:var(--text-muted)">No items completed</p>'}</div>`;
    }else content='<p style="text-align:center;color:var(--text-muted)">No data recorded yet.</p>';
    document.getElementById('modalDayContent').innerHTML=content;document.getElementById('dayModal').classList.add('active');
}
function closeModal(){document.getElementById('dayModal').classList.remove('active');}
document.getElementById('dayModal').addEventListener('click',e=>{if(e.target.id==='dayModal')closeModal();});

// CHARTS
function renderCharts(){
    const isDark=APP_STATE.theme==='dark';const gridColor=isDark?'rgba(255,255,255,0.08)':'rgba(0,0,0,0.08)';const textColor=isDark?'#9ca3af':'#666';
    // Trend
    const labels=[],percents=[],pts=[];
    for(let d=1;d<=30;d++){labels.push(d);const x=getDayData(d);percents.push(x?x.percentage:0);pts.push(x?x.points||0:0);}
    if(trendChartInst)trendChartInst.destroy();
    trendChartInst=new Chart(document.getElementById('trendChart'),{type:'line',data:{labels,datasets:[{label:'Completion %',data:percents,borderColor:isDark?'#34d399':'#1b5e3b',backgroundColor:isDark?'rgba(52,211,153,0.1)':'rgba(27,94,59,0.1)',fill:true,tension:.3,pointRadius:3}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100,grid:{color:gridColor},ticks:{color:textColor}},x:{grid:{color:gridColor},ticks:{color:textColor,maxTicksLimit:10}}},plugins:{legend:{display:false}}}});
    // Quran
    const qLabels=[],qCumul=[];let cum=0;
    for(let d=1;d<=30;d++){qLabels.push(d);cum+=(quranPages[d]||0);qCumul.push(cum);}
    const target=[];for(let d=1;d<=30;d++)target.push(Math.round((d/30)*604));
    if(quranChartInst)quranChartInst.destroy();
    quranChartInst=new Chart(document.getElementById('quranChart'),{type:'line',data:{labels:qLabels,datasets:[{label:'Pages Read',data:qCumul,borderColor:'#f5c542',backgroundColor:'rgba(245,197,66,0.1)',fill:true,tension:.3,pointRadius:3},{label:'Target',data:target,borderColor:isDark?'rgba(255,255,255,0.2)':'rgba(0,0,0,0.15)',borderDash:[5,5],pointRadius:0,fill:false}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:604,grid:{color:gridColor},ticks:{color:textColor}},x:{grid:{color:gridColor},ticks:{color:textColor,maxTicksLimit:10}}},plugins:{legend:{labels:{color:textColor,boxWidth:12,font:{size:11}}}}}});
}

// COMPARISON
function updateComparison(){
    function weekAvg(s,e){let t=0,c=0;for(let d=s;d<=e;d++){const x=getDayData(d);if(x&&x.percentage>0){t+=x.percentage;c++;}}return c>0?Math.round(t/c):0;}
    const w1=weekAvg(1,7),w2=weekAvg(8,14),w3=weekAvg(15,21),w4=weekAvg(22,30);
    const currentWeek=APP_STATE.currentDay<=7?1:APP_STATE.currentDay<=14?2:APP_STATE.currentDay<=21?3:4;
    const weeks=[w1,w2,w3,w4];const curAvg=weeks[currentWeek-1];const prevAvg=currentWeek>1?weeks[currentWeek-2]:0;
    document.getElementById('compWeek1').textContent=(currentWeek>1?prevAvg:w1)+'%';
    document.getElementById('compWeek2').textContent=curAvg+'%';
    document.querySelector('#comparisonRow .comparison-card:first-child .comp-label').textContent=currentWeek>1?`Week ${currentWeek-1} Avg`:'Week 1 Avg';
    document.querySelector('#comparisonRow .comparison-card:last-child .comp-label').textContent=`Week ${currentWeek} Avg`;
    const delta=document.getElementById('compDelta');
    if(currentWeek>1&&prevAvg>0){
        const diff=curAvg-prevAvg;delta.style.display='block';
        document.getElementById('compDeltaVal').textContent=(diff>=0?'+':'')+diff+'%';
        document.getElementById('compDeltaVal').style.color=diff>=0?'var(--success)':'var(--error)';
        document.getElementById('compDeltaLabel').textContent=diff>=0?`You're doing ${Math.abs(diff)}% better than last week!`:`${Math.abs(diff)}% lower than last week ‚Äî you can do this!`;
    }else delta.style.display='none';
}

// STATS
function updateStats(){
    let dc=0,tp=0,tpt=0,bd={day:0,percent:0},pd=0;
    for(let d=1;d<=30;d++){const x=getDayData(d);if(x&&x.percentage>0){dc++;tp+=x.percentage;tpt+=x.points||0;if(x.percentage>bd.percent)bd={day:d,percent:x.percentage};if(x.percentage===100)pd++;}}
    document.getElementById('statDaysCompleted').textContent=`${dc} / 30`;
    document.getElementById('statAvgCompletion').textContent=(dc>0?Math.round(tp/dc):0)+'%';
    document.getElementById('statTotalPoints').textContent=tpt.toLocaleString();
    document.getElementById('statBestDay').textContent=bd.day>0?`Day ${bd.day} (${bd.percent}%)`:'-';
    document.getElementById('statPerfectDays').textContent=pd;
    const bs=getBestStreaks();
    document.getElementById('bestStreakFajr').textContent=bs.fajr+' days';document.getElementById('bestStreakNight').textContent=bs.night+' days';
    document.getElementById('bestStreakQuran').textContent=bs.quran+' days';document.getElementById('bestStreakCharity').textContent=bs.charity+' days';
    updateCategoryBreakdown();updateQuranTracker();
}
function updateCategoryBreakdown(){
    const c=document.getElementById('categoryBreakdown');
    const cats=[{id:'salah',name:'Salah & Dhikr'},{id:'quran',name:'Quran'},{id:'character',name:'Character'},{id:'charity',name:'Charity'},{id:'avoidance',name:'Avoidance'}];
    c.innerHTML=cats.map(cat=>{const sec=CHECKLIST_DATA.find(s=>s.id===cat.id);if(!sec)return'';let co=0,t=0;
        if(sec.subcategories)sec.subcategories.forEach(sub=>sub.items.forEach(it=>{t++;const cb=document.getElementById(it.id);if(cb&&cb.checked)co++;}));
        if(sec.items)sec.items.forEach(it=>{t++;const cb=document.getElementById(it.id);if(cb&&cb.checked)co++;});
        const pct=t>0?Math.round((co/t)*100):0;
        return `<div class="category-bar"><div class="category-bar-header"><span>${cat.name}</span><span>${pct}%</span></div><div class="category-bar-track"><div class="category-bar-fill" style="width:${pct}%"></div></div></div>`;
    }).join('');
}

// PDF REPORT
function generatePDF(){
    const{jsPDF}=window.jspdf;const doc=new jsPDF();const W=210,M=15;let y=20;
    const green=[27,94,59],gold=[201,168,76],dark=[26,26,46];
    // Header
    doc.setFillColor(...dark);doc.rect(0,0,W,40,'F');
    doc.setFillColor(...gold);doc.rect(0,38,W,2,'F');
    doc.setTextColor(255,255,255);doc.setFontSize(22);doc.text('RAMADAN STRIVERS',M,20);
    doc.setFontSize(10);doc.setTextColor(...gold);doc.text('From Muslim to Mu\'min ‚Äî Progress Report',M,30);
    doc.setTextColor(255,255,255);doc.setFontSize(9);doc.text(`Generated: ${new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}`,W-M,20,{align:'right'});
    y=52;doc.setTextColor(0,0,0);

    // Overall Stats
    doc.setFillColor(...green);doc.rect(M,y-6,W-2*M,10,'F');
    doc.setTextColor(255,255,255);doc.setFontSize(12);doc.text('OVERALL PROGRESS',M+4,y+1);
    y+=14;doc.setTextColor(50,50,50);doc.setFontSize(10);
    let dc=0,tp=0,tpt=0,pd=0;
    for(let d=1;d<=30;d++){const x=getDayData(d);if(x&&x.percentage>0){dc++;tp+=x.percentage;tpt+=x.points||0;if(x.percentage===100)pd++;}}
    const avg=dc>0?Math.round(tp/dc):0;
    let totalQ=0;for(let d=1;d<=30;d++){if(quranPages[d])totalQ+=quranPages[d];}
    const stats=[['Days Completed',`${dc} / 30`],['Average Completion',`${avg}%`],['Total Points',tpt.toLocaleString()],['Perfect Days',pd.toString()],['Quran Pages',`${totalQ} / 604`]];
    stats.forEach(([l,v])=>{doc.text(l,M,y);doc.setTextColor(...green);doc.text(v,W-M,y,{align:'right'});doc.setTextColor(50,50,50);y+=8;});

    // Daily Breakdown
    y+=6;doc.setFillColor(...green);doc.rect(M,y-6,W-2*M,10,'F');
    doc.setTextColor(255,255,255);doc.setFontSize(12);doc.text('DAILY BREAKDOWN',M+4,y+1);
    y+=12;doc.setTextColor(50,50,50);doc.setFontSize(8);
    // Header row
    doc.setFillColor(240,240,240);doc.rect(M,y-4,W-2*M,8,'F');
    doc.setTextColor(80,80,80);doc.text('Day',M+2,y+1);doc.text('Completion',M+30,y+1);doc.text('Points',M+65,y+1);doc.text('Quran',M+90,y+1);
    y+=10;doc.setTextColor(50,50,50);
    for(let d=1;d<=30;d++){
        if(y>270){doc.addPage();y=20;}
        const x=getDayData(d);const qp=quranPages[d]||0;
        if(x&&x.percentage>0){doc.setFillColor(240,250,240);doc.rect(M,y-4,W-2*M,7,'F');}
        doc.text(`Day ${d}`,M+2,y);doc.text(x?`${x.percentage}%`:'‚Äî',M+30,y);doc.text(x?`${x.points||0}`:'‚Äî',M+65,y);doc.text(qp>0?`${qp}p`:'‚Äî',M+90,y);
        y+=7;
    }
    // Best Streaks
    y+=8;if(y>250){doc.addPage();y=20;}
    doc.setFillColor(...green);doc.rect(M,y-6,W-2*M,10,'F');
    doc.setTextColor(255,255,255);doc.setFontSize(12);doc.text('BEST STREAKS',M+4,y+1);
    y+=12;doc.setTextColor(50,50,50);doc.setFontSize(10);
    const bs=getBestStreaks();
    [['Fajr',bs.fajr],['Night Prayer',bs.night],['Quran',bs.quran],['Sadaqah',bs.charity]].forEach(([l,v])=>{doc.text(l,M,y);doc.setTextColor(...green);doc.text(`${v} days`,W-M,y,{align:'right'});doc.setTextColor(50,50,50);y+=8;});
    // Footer
    y+=10;if(y>270){doc.addPage();y=20;}
    doc.setDrawColor(...gold);doc.line(M,y,W-M,y);y+=8;
    doc.setFontSize(9);doc.setTextColor(...gold);doc.text('May Allah accept our fasting and deeds. Ramadan Mubarak!',W/2,y,{align:'center'});
    y+=6;doc.setTextColor(150,150,150);doc.setFontSize(7);doc.text('Ramadan Strivers ‚Äî ramadanstrivers.com',W/2,y,{align:'center'});
    doc.save(`Ramadan-Strivers-Report-Day-${APP_STATE.currentDay}.pdf`);
    showToast('PDF report downloaded! üìÑ');
}

// INSTALL PWA
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;document.getElementById('installBanner').classList.add('show');});
function checkInstall(){
    const dismissed=localStorage.getItem('rs-install-dismissed');if(dismissed)return;
    const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);const isStandalone=window.matchMedia('(display-mode:standalone)').matches||window.navigator.standalone;
    if(isIOS&&!isStandalone){
        document.getElementById('installBtn').textContent='How';
        document.getElementById('installBanner').classList.add('show');
        document.getElementById('installBtn').onclick=()=>{showToast('Tap the Share button ‚¨Ü then "Add to Home Screen"');};
    }
}
function installApp(){if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then(r=>{if(r.outcome==='accepted')showToast('App installed! üéâ');deferredPrompt=null;document.getElementById('installBanner').classList.remove('show');});}}
function dismissInstall(){document.getElementById('installBanner').classList.remove('show');localStorage.setItem('rs-install-dismissed','1');}

// TOAST
function showToast(msg,type='default'){const c=document.getElementById('toastContainer');const t=document.createElement('div');t.className=`toast ${type==='badge'?'badge-toast':''}`;t.textContent=msg;c.appendChild(t);setTimeout(()=>t.remove(),3000);}

// DATA MANAGEMENT
function exportData(){const data={settings:APP_STATE,badges:getUnlockedBadges(),bestStreaks:getBestStreaks(),quranPages,days:{}};for(let d=1;d<=30;d++){const x=getDayData(d);if(x)data.days[d]=x;}const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`ramadan-strivers-${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(url);showToast('Data exported!');}
function importData(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=e=>{try{const data=JSON.parse(e.target.result);if(data.settings)localStorage.setItem('rs-settings',JSON.stringify(data.settings));if(data.badges)localStorage.setItem('rs-badges',JSON.stringify(data.badges));if(data.bestStreaks)localStorage.setItem('rs-best-streaks',JSON.stringify(data.bestStreaks));if(data.quranPages)localStorage.setItem('rs-quran-pages',JSON.stringify(data.quranPages));if(data.days)Object.entries(data.days).forEach(([d,dd])=>localStorage.setItem(`rs-day-${d}`,JSON.stringify(dd)));showToast('Imported! Reloading‚Ä¶');setTimeout(()=>location.reload(),1500);}catch(err){showToast('Error importing data.');}};reader.readAsText(file);}
function confirmReset(){if(confirm('Reset ALL data? This cannot be undone!')){if(confirm('This deletes all progress. Continue?')){const keys=[];for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&k.startsWith('rs-'))keys.push(k);}keys.forEach(k=>localStorage.removeItem(k));showToast('Reset.');setTimeout(()=>location.reload(),1500);}}}

// SW
function registerSW(){if('serviceWorker' in navigator){const code=`const C='rs-v4';self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(['/'])));self.skipWaiting();});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).catch(()=>new Response('Offline'))));});self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(n=>Promise.all(n.filter(x=>x!==C).map(x=>caches.delete(x)))));});`;navigator.serviceWorker.register(URL.createObjectURL(new Blob([code],{type:'application/javascript'}))).catch(()=>{});}}
</script>
</body>
</html>
